name: Test & Deploy

on:
  push:
    branches: [main]

# Only one deploy can run at a time; a newer push cancels an in-progress one.
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:

  # ── 1. Tests ──────────────────────────────────────────────────────────────
  test:
    name: Run backend tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: lhsffl-servers

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: lhsffl-servers/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-flask

      - name: Run tests
        env:
          LEAGUE_ID: ci_placeholder
        run: pytest tests/ -v --tb=short

  # ── 2. Deploy backend (Elastic Beanstalk) ────────────────────────────────
  deploy-backend:
    name: Deploy backend → Elastic Beanstalk
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Package backend (exclude dev-only dirs)
        run: |
          cd lhsffl-servers
          zip -r ../backend.zip . \
            --exclude "venv/*" \
            --exclude "__pycache__/*" \
            --exclude "*.pyc" \
            --exclude "tests/*" \
            --exclude "instance/*" \
            --exclude ".elasticbeanstalk/*"

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v22
        with:
          aws_access_key:        ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key:        ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          region:                us-west-2
          application_name:      dynasty
          environment_name:      dynasty-api-prod-v2
          version_label:         ${{ github.sha }}
          deployment_package:    backend.zip
          wait_for_environment_recovery: 120

  # ── 3. Deploy frontend (S3 + CloudFront) ─────────────────────────────────
  deploy-frontend:
    name: Deploy frontend → S3 + CloudFront
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            us-east-1   # CloudFront requires us-east-1 for invalidations

      - name: Sync build to S3
        run: |
          aws s3 sync build/ s3://dynasty-frontend-1756185428 \
            --delete \
            --exact-timestamps

      - name: Set cache headers on index.html
        run: |
          aws s3 cp s3://dynasty-frontend-1756185428/index.html \
                    s3://dynasty-frontend-1756185428/index.html \
            --metadata-directive REPLACE \
            --content-type "text/html" \
            --cache-control "no-cache"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E3OOF4NEFGSZ0A \
            --paths "/*"
